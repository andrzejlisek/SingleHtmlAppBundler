# Sample projects

The **SingleHtmlAppBundler** project contains samples, which can be used for demonstration and test purposes\. These samples are in **Samples** directory, which contains these subdirectories and files:


* **Multimedia** \- Sample containing scripts or miscellaneous media files, which demonstrates all supported HTML tags JavaScript/CSS tokens\.
  * **index\.html** \- Sample root file\.
* **WebAssembly** \- Sample WebAssembly program compiled with threads and without threads\. Actually, there are two independed samples:
  * **wasmtest\.cpp** \- Program source code, other files are generated by Emscripten compiler\. Other files are generated by **Emscripten** and are not modified\.
  * **wasmtest0\.html** \- Compiled program root file without threads\. The sample uses some HTML tags and JavaScript **fetch**\.
  * **wasmtest1\.html** \- Compiled program root file with threads\. The sample uses some HTML tags and JavaScript **fetch**, **Worker**, **importScripts**\.
* **Bundled** \- All samples bundled using **SingleHtmlAppBundler**\.
  * **multimedia\_0\.html** \- Multimedia samples without any minification\. HTTP server not required to run\.
  * **multimedia\_1\.html** \- Multimedia samples with all minifications\. HTTP server not required to run\.
  * **wasmtest0\_0\.html** \- WebAssembly without threads without any minification\. HTTP server not required to run\.
  * **wasmtest0\_1\.html** \- WebAssembly without threads with all minifications\. HTTP server not required to run\.
  * **wasmtest1\_0\.php** \- WebAssembly with threads without any minification\. Requires any HTTP server supporting PHP language to run\.
  * **wasmtest1\_1\.php** \- WebAssembly with threads with all minifications\. Requires any HTTP server supporting PHP language to run\.
* **BundleSamples\.sh** \- Bundling script for all samples\. At once, bundles minified or unminified\. These script is compatible with Linux Bash\.
* **PrepareWasm1\.txt** \- Code preparation file for wasmtest0\.html\.
* **PrepareWasm2\.txt** \- Code preparation file for wasmtest1\.html, first step, bundling the project is splitted into two steps\.
* **PrepareWasm3\.txt** \- Code preparation file for wasmtest1\.html, second step, bundling the project is splitted into two steps\.

In the source \(unbundled\) projects not all features will work directly as **file:///directory/file\.html**, because web browsers obeys the **Same\-Origin Policy**, so all required files will not be loaded\. If you run the project on HTTP server as **http://address/file\.html**, all features will be work in exceptions of WebAssembly threads due to **SharedArrayBuffer** requirement\. Web browser enables **SharedArrayBuffer** when the GET/POST response contains the following headers:

```
Cross-Origin-Embedder-Policy: require-corp
Cross-Origin-Opener-Policy: same-origin
```

Otherwise, the program with threads will not work and in the web browser console there will be error message about lack of the **SharedArrayBuffer**\.

## Bundling samples

These **BundleSamples\.sh** Bash script file bundles all three samples into the Bundled subdirectory\. Before running, you should open this fine in text editor and edit the vriable assignments:


* **AppDir** \- Directory, where is placed the **SingleHtmlAppBundler\.dll** application file\.
* **SamplesDir** \- Directory containing the samples
* **Minify** \- One of these values:
  * **0** \- The bundled project will not be minified and the bundled file name will have **\_0** suffix\.
  * **1** \- The bundled project will be minified and the bundled file name will have **\_1** suffix\.

## WebAssembly limitations and workarounds

The WebAssembly programs generally can run without threads\. For run with threads, you have to force the **SharedArrayBuffer** to be enabled\. You can do this by following ways:


* Configure the HTTP server for send additional mentioned headers for any GET response\.
* Add the HTTP headers using any server\-side language supported by the server, like PHP\.
* Use the **coi\-serviceworker** script:
  * [https://github\.com/gzuidhof/coi\-serviceworker](https://github.com/gzuidhof/coi-serviceworker "https://github.com/gzuidhof/coi-serviceworker")
  * [https://www\.npmjs\.com/package/coi\-serviceworker](https://www.npmjs.com/package/coi-serviceworker "https://www.npmjs.com/package/coi-serviceworker")

The simplest way fo run WebAssembly with threads is using the HTTP server supporting PHP language\. There is the reason, why the bundled WebAssembly sample with threads is in PHP format\.

The project original files other than **wasmtest\.cpp** is automatically generated by **Emscripten** by the following compile commands:

```
emcc wasmtest.cpp -o wasmtest0.html -s "EXPORTED_RUNTIME_METHODS=['ccall','cwrap']"
emcc wasmtest.cpp -o wasmtest1.html -s "EXPORTED_RUNTIME_METHODS=['ccall','cwrap']" -pthread -s PTHREAD_POOL_SIZE=5
```

## Cyclic references

Bundling **wasmtest1\.html** in single step is not possible, because all text replacement at once inside **wasmtest1\.js** and **wasmtest1\.worker\.js** files makes cyclic reference for each other:


* **wasmtest1\.js** creates the Worker object using **wasmtest1\.worker\.js** file\.
* **wasmtest1\.worker\.js** performs the importScripts importing the **wasmtest1\.js** file\.

Originally, in these files, the names are not provided directly, but theoretically can be placed by text replacement defined in code preparation file\. In practice, trying to bundle any of the mentioned JS files without text replacement results, that the other file is not visible and will not be bundled\.

The sample must be bundled by two steps:


* **Step 1**: Bundle **wasmtest1\.worker\.js** file with text replacement in this file only to make reference to **wasmtest1\.js** file\.
* Between the steps, you have to rename the bundled **wasmtest1\.worker\.js** file into oher name, for example **\_bundled\_wasmtest1\.worker\.js** file, then you have to place the file in the project directory\.
* **Step 2**: Bundle **wasmtest1\.html** file, using code preparation file, you have to make reference to **\_bundled\_wasmtest1\.worker\.js** file instead of **wasmtest1\.worker\.js** file in **wasmtest1\.js** file\.
* Now, you can remove the **\_bundled\_wasmtest1\.worker\.js** file existing in the source directory\.




